# .github/workflows/ci-cd.yml

name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0 # Fetch all history for all tags and branches

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Установим также pytest для тестов
        pip install pytest

    - name: Run unit tests
      run: |
        pytest tests/ -v --cov=src --cov-report=xml

    - name: Lint with flake8
      run: |
        flake8 src/ tests/

    - name: Check formatting with black
      run: |
        black --check src/ tests/

    - name: Run Great Expectations validation (on raw data)
      run: |
        # Убедимся, что GE инициализирован
        # great_expectations --version # Опционально, для отладки
        # Запустим валидацию на train.csv
        python -c "
        import pandas as pd
        import great_expectations as ge
        from great_expectations.data_context import DataContext

        df = ge.read_csv('data/processed/train.csv')
        context = DataContext()
        suite = context.get_expectation_suite('credit_data_suite')
        validator = ge.Validator(batch=df, expectation_suite=suite)
        results = validator.validate()
        print(f'Validation Success: {results.success}')
        if not results.success:
            print('Validation Failed!')
            for result in results.results:
                if not result.success:
                    print(f'  Failed expectation: {result.expectation_config}')
            exit(1)
        else:
            print('Validation Passed!')
        "
      env:
        PYTHONPATH: ${{ github.workspace }}
